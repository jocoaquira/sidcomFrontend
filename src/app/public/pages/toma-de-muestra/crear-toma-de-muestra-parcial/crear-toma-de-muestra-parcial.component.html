<!-- VISTA DE GESTIÓN DE PARCIALES (Se muestra después de crear el padre) -->
<div *ngIf="muestraPadreCreada" class="card">
    <div class="card-titulo">
        <h4 class="text-center" style="color: white;">GESTIÓN DE PARCIALES - LOTE: {{muestraPadre?.lote}}</h4>
    </div>

    <div class="grid p-fluid mt-3">
        <!-- Información de la Muestra Padre -->
        <div class="col-12">
            <p-card styleClass="p-card-shadow">
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3">
                        <span class="text-xl font-bold">Muestra Parcial Padre</span>
                        <p-tag value="PARCIAL PADRE" severity="warning" styleClass="text-lg"></p-tag>
                    </div>
                </ng-template>
                <div class="grid">
                    <div class="col-12 md:col-3">
                        <strong>Nro. Formulario:</strong> {{muestraPadre?.nro_formulario}}
                    </div>
                    <div class="col-12 md:col-3">
                        <strong>Estado:</strong>
                        <p-tag [value]="muestraPadre?.procedimiento_parcial === 'EMITIDO' ? 'FINALIZADO' : muestraPadre?.estado"
                               [severity]="muestraPadre?.procedimiento_parcial === 'EMITIDO' ? 'success' :
                                          muestraPadre?.estado === 'APROBADO' ? 'success' :
                                          muestraPadre?.estado === 'SOLICITADO' ? 'info' :
                                          muestraPadre?.estado === 'FIRMADO' ? 'success' : 'warning'">
                        </p-tag>
                    </div>
                    <div class="col-12 md:col-3">
                        <strong>Lote:</strong> {{muestraPadre?.lote}}
                    </div>
                    <div class="col-12 md:col-3">
                        <strong>Nro. Parciales Planeados:</strong> <span class="text-primary font-bold">{{muestraPadre?.nro_parcial || 'N/A'}}</span>
                    </div>
                    <div class="col-12" *ngIf="muestraPadre?.procedimiento_parcial === 'EMITIDO'">
                        <p-message severity="success" text="Parcial finalizado. Ya no se pueden generar mas parciales hijos."></p-message>
                    </div>
                    <div class="col-12 md:col-6">
                        <strong>Peso Total Aproximado:</strong> {{muestraPadre?.peso_neto_total}} Kg
                    </div>
                    <div class="col-12 md:col-3">
                        <strong>Peso Disponible:</strong> {{pesoRestante}} Kg
                    </div>
                    <div class="col-12 md:col-3">
                        <strong>Camiones Disponibles:</strong> {{camionesRestantes}}
                    </div>
                    <div class="col-12 md:col-6">
                        <strong>Lugar Verificación:</strong> {{muestraPadre?.lugar_verificacion}}
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Botones de acción según el estado -->
        <div class="col-12">
            <!-- Botón SOLICITAR (solo si está en GENERADO) -->
            <button *ngIf="muestraPadre?.estado === 'GENERADO'"
                    pButton pRipple type="button"
                    label="Solicitar Aprobación"
                    icon="pi pi-send"
                    class="p-button-info mr-2"
                    (click)="solicitarMuestraPadre()">
            </button>

            <!-- Mensaje cuando está SOLICITADO -->
            <p-message *ngIf="muestraPadre?.estado === 'SOLICITADO'"
                       severity="info"
                       text="Esperando aprobación de GADOR. Una vez aprobada podrá generar los parciales.">
            </p-message>
            <button *ngIf="muestraPadre?.estado === 'SOLICITADO'"
                    pButton pRipple type="button"
                    label="Actualizar estado"
                    icon="pi pi-refresh"
                    class="p-button-secondary ml-2"
                    (click)="actualizarMuestraPadre()">
            </button>

            <!-- Botón GENERAR PARCIALES (solo si está APROBADO o FIRMADO) -->
            <button *ngIf="muestraPadre?.procedimiento_parcial !== 'EMITIDO' && ((muestraPadre?.estado || '').trim() === 'APROBADO' || (muestraPadre?.estado || '').trim() === 'FIRMADO')"
                    pButton pRipple type="button"
                    label="Generar Parcial Hijo"
                    icon="pi pi-plus"
                    class="p-button-success"
                    (click)="abrirDialogoAgregarParcial()">
            </button>
        </div>

        <!-- Tabla de parciales hijos (visible para APROBADO, FIRMADO o CERRADO) -->
        <div class="col-12" *ngIf="(muestraPadre?.estado || '').trim() === 'APROBADO' || (muestraPadre?.estado || '').trim() === 'FIRMADO' || (muestraPadre?.estado || '').trim() === 'CERRADO'">
            <p-card styleClass="p-card-shadow">
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3">
                        <span class="text-xl font-bold">Parciales Hijos Generados ({{parcialesHijos.length}} / {{muestraPadre?.nro_parcial || 0}})</span>
                        <p-tag [value]="'Progreso: ' + Math.floor((parcialesHijos.length / (muestraPadre?.nro_parcial || 1)) * 100) + '%'"
                               [severity]="parcialesHijos.length >= (muestraPadre?.nro_parcial || 0) ? 'success' : 'info'">
                        </p-tag>
                    </div>
                </ng-template>
                <p-table [value]="parcialesHijos" responsiveLayout="scroll" [rows]="10" [paginator]="true">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Tipo</th>
                            <th>Nro. Formulario</th>
                            <th>Peso Neto (Kg)</th>
                            <th>Nro. Camiones</th>
                            <th>Estado</th>
                            <th>Fecha Creación</th>
                            <th>Acciones</th>
                            <th>Imprimir</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-parcial let-rowIndex="rowIndex">
                        <tr>
                            <td>
                                <p-tag value="HIJO" severity="info" styleClass="text-sm"></p-tag>
                            </td>
                            <td>{{parcial.nro_formulario}}</td>
                            <td>{{parcial.peso_neto_total}}</td>
                            <td>{{parcial.nro_camiones}}</td>
                            <td>
                                <p-tag [value]="parcial.estado"
                                    [severity]="parcial.estado === 'APROBADO' ? 'success' :
                                               parcial.estado === 'SOLICITADO' ? 'info' :
                                               parcial.estado === 'FIRMADO' ? 'success' : 'warning'">
                                </p-tag>
                            </td>
                            <td>{{parcial.created_at | date:'dd/MM/yyyy HH:mm'}}</td>
                                                        <td>
                                <div class="flex">
                                    <button pButton pRipple icon="pi pi-eye"
                                            (click)="verSolicitud(parcial)"
                                            class="p-button-outlined p-button-info mr-2"></button>
                                    <button *ngIf="parcial.estado === 'GENERADO'" pButton pRipple icon="pi pi-pencil"
                                            class="p-button-outlined p-button-warning mr-2"
                                            routerLink="/public/toma-de-muestra/editar/{{parcial?.id}}"></button>
                                    <button *ngIf="parcial.estado === 'GENERADO'" pButton pRipple icon="pi pi-send"
                                            (click)="confirmarSolicitudParcial(parcial)" label="Solicitar"
                                            class="p-button-outlined p-button-success mr-2"></button>
                                    <button *ngIf="parcial.estado === 'EMITIDO'" pButton pRipple icon="pi pi-check-circle"
                                            (click)="confirmarAprobacionParcial(parcial)" label="Aprobar"
                                            class="p-button-outlined p-button-success mr-2"></button>
                                    <button *ngIf="parcial.estado !== 'ANULADO' && parcial.estado !== 'APROBADO' && parcial.estado !== 'EMITIDO'"
                                            pButton pRipple icon="pi pi-trash" label="Anular"
                                            class="p-button-outlined p-button-danger mr-2"
                                            routerLink="/public/toma-de-muestra/anular/{{parcial?.id}}"></button>
                                </div>
                            </td>
                            <td>
                                <div class="flex">
                                    <button pButton pRipple icon="pi pi-print"
                                            class="p-button-outlined p-button-info mr-2"
                                            (click)="generarPDFParcial(parcial)"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center">
                                <p-message severity="info" text="No hay parciales hijos generados aún. Use el botón 'Generar Parcial Hijo' para agregar." styleClass="w-full"></p-message>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>

        <!-- Botón para finalizar -->
        <div class="col-12 text-center">
            <button pButton pRipple type="button" label="Finalizar y Volver a Lista" icon="pi pi-check"
                class="p-button-primary" (click)="volverAFormulario()"></button>
        </div>
    </div>
</div>

<!-- FORMULARIO ORIGINAL (Se oculta cuando se crea el padre) -->
<form [formGroup]="formulario_interno.formulario" (ngSubmit)="onSubmit()" *ngIf="!muestraPadreCreada">
    <p-dialog (onShow)="actualizarMapa()" [(visible)]="mapaDialogo" [style]="{width: '800px',height:'800px'}" header="Mapa (Hacer click en el lugar que desee)" [modal]="true" class="p-fluid">
        <div style="height: 90%;" leaflet [leafletOptions]="options" [leafletLayers]="[streetLayer,satelliteLayer]" (leafletMapReady)="onMapReady($event)"></div>
        <div class="grid p-fluid" >
            <div class="col-12 md:col-6">
                <button (click)="agregarPunto()" pButton pRipple type="button" icon="pi pi-plus" label="Agregar" class="p-button-outlined p-button-info" ></button>
            </div>
            <div class="col-12 md:col-6">
                <button pButton pRipple type="button" icon="pi pi-times" label="Cancelar" class="p-button-outlined p-button-danger"></button>
            </div>
        </div>
    </p-dialog>


  <div class="card-titulo">
      <h4 class="text-center" style="color: white;">CREACION DE NUEVA TOMA DE MUESTRA PARCIAL</h4>
  </div>
      <div class="grid p-fluid">
          <div class="card card-w-title flex flex-wrap col-12">
              <div class="col-12">
                  <p-steps [model]="steps" [(activeIndex)]="activeStep"
                  styleClass="mt-1" [readonly]="false"
                  ></p-steps>
              </div>
              <div class="col-12" >
                  <div *ngIf="activeStep === 0"
                  >
                  <div class="grid p-fluid">
                    <div class="field col-12 md:col-9" *ngIf="!valSwitch">
                        <span class="p-float-label">
                            <p-dropdown
                                inputId="dropdown"
                                [autoDisplayFirst]="false"
                                [options]="listaLugaresVerificacion"
                                optionLabel="lugar"
                                (onChange)="cambioLugarVerificacionTDM($event)"
                            ></p-dropdown>

                            <label for="dropdown">Lugar de Verificación de Toma de Muestra</label>
                        </span>
                    </div>
                    <div class="field col-12 md:col-3">
                        <div class="field-checkbox">
                            <p-inputSwitch (onChange)="valSwitches($event)"></p-inputSwitch>
                            <label for="sf">Otro Lugar de Toma de Muestra</label>
                        </div>

                    </div>
                </div>
                        <div class="grid p-fluid" *ngIf="valSwitch">
                            <div class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <p-dropdown
                                        inputId="municipio"
                                        [autoDisplayFirst]="false"
                                        [options]="municipio"
                                        formControlName="municipio_id"
                                        optionLabel="municipio"
                                        optionValue="id"
                                        (onChange)="cambioMunicipioMapa($event)"
                                    ></p-dropdown>
                                    <label for="dropdown">Municipio</label>
                                    <small id="municipio_id" class="p-error " *ngIf="formulario_interno.esCampoInvalido('municipio_id')">
                                        {{formulario_interno.getErrorMessage('municipio_id')}}
                                    </small>
                                </span>
                            </div>


                              <div class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="ubicacion_lat"
                                        pInputText
                                        formControlName="ubicacion_lat"
                                    />
                                    <label for="ubicacion_lat">Latitud </label>
                            <small id="ubicacion_lat" class="p-error " *ngIf="formulario_interno.esCampoInvalido('ubicacion_lat')">
                                        {{formulario_interno.getErrorMessage('ubicacion_lat')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="ubicacion_lon"
                                        pInputText
                                        formControlName="ubicacion_lon"
                                    />
                                    <label for="ubicacion_lon">Longitud </label>
                            <small id="ubicacion_lon" class="p-error " *ngIf="formulario_interno.esCampoInvalido('ubicacion_lon')">
                                        {{formulario_interno.getErrorMessage('ubicacion_lon')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-2">
                                <button pButton pRipple type="button" icon="pi pi-map" label="Buscar en Mapa" class="p-button-outlined p-button-info" (click)="abrirMapa()"></button>
                            </div>

                            <div class="field col-12 md:col-12">
                                  <span class="p-float-label">
                                      <input
                                          type="text"
                                          id="lugar_verificacion"
                                          pInputText
                                          formControlName="lugar_verificacion"
                                class="ng-dirty"
                                />
                                      <label for="lugar_verificacion">Lugar de Verificación </label>
                                    <small id="lugar_verificacion" class="p-error " *ngIf="formulario_interno.esCampoInvalido('lugar_verificacion')">
                                          {{formulario_interno.getErrorMessage('lugar_verificacion')}}
                                    </small>
                                  </span>
                            </div>
                        </div>

                        <div class="field col-12 md:col-12" *ngIf="!admin">
                            <span class="p-float-label mt-5">
                                <p-dropdown
                                    inputId="dropdown"
                                    [autoDisplayFirst]="false"
                                    [options]="listaUsuarios"
                                    formControlName="responsable_tdm_id"
                                    optionLabel="nombreCompleto"
                                    optionValue="id"
                                ></p-dropdown>

                                <label for="dropdown">Responsable de Toma de Muestra</label>
                                <small id="responsable_tdm_id" class="p-error " *ngIf="formulario_interno.esCampoInvalido('responsable_tdm_id')">
                                    {{formulario_interno.getErrorMessage('responsable_tdm_id')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-12">
                            <span class="p-float-label">
                                <p-calendar
                                    inputId="fecha_hora_tdm"
                                    dateFormat="dd-mm-yy"
                                    formControlName="fecha_hora_tdm"
                                    [showTime]="true"
                                    hourFormat="24"
                                ></p-calendar>
                                <label for="calendar">Fecha y Hora de Toma de Muestra</label>
                                <small id="nit" class="p-error" *ngIf="formulario_interno.esCampoInvalido('fecha_hora_tdm')">
                                    {{formulario_interno.getErrorMessage('fecha_hora_tdm')}}
                                </small>
                            </span>
                        </div>

                      </div>
                  </div>
                  <div *ngIf="activeStep === 1"
                  >
                      <div class="grid p-fluid mt-2">
                        <div class="field col-12 md:col-12 ">
                            <h5>2.1 Datos del Mineral </h5>
                        </div>
                        <div class="field col-12 md:col-6">
                            <span class="p-float-label">
                                <input
                                    type="text"
                                    id="lote"
                                    pInputText
                                    formControlName="lote"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Lote</label>
                                <small id="lote" class="p-error "*ngIf="formulario_interno.esCampoInvalido('lote')">
                                    {{formulario_interno.getErrorMessage('lote')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-5">
                            <span class="p-float-label">
                                <p-dropdown
                                    inputId="dropdown"
                                    [autoDisplayFirst]="false"
                                    [options]="presentaciones"
                                    formControlName="presentacion_id"
                                    optionLabel="nombre"
                                    optionValue="id"
                                    (onChange)="cambioPresentacion($event)"
                                ></p-dropdown>
                                <label for="dropdown">Presentacion</label>
                                <small id="presentacion_id" class="p-error " *ngIf="formulario_interno.esCampoInvalido('presentacion_id')">
                                    {{formulario_interno.getErrorMessage('presentacion_id')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-3">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="cantidad"
                                    pInputText
                                    formControlName="cantidad"
                                    class="ng-dirty"
                                    [disabled]="presentacion.cantidad"
                                />
                                <label for="Razón Social">Cantidad</label>
                                <small id="cantidad" class="p-error "*ngIf="formulario_interno.esCampoInvalido('cantidad')">
                                    {{formulario_interno.getErrorMessage('cantidad')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-4">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="nro_camiones"
                                    pInputText
                                    formControlName="nro_camiones"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Nro. de Camiones/Vagones Total de Parciales</label>
                                <small id="nro_camiones" class="p-error "*ngIf="formulario_interno.esCampoInvalido('nro_camiones')">
                                    {{formulario_interno.getErrorMessage('nro_camiones')}}
                                </small>
                            </span>
                        </div>

                        <div *ngIf="false" class="field col-12 md:col-4 ">
                            <span class="p-float-label">
                                <p-dropdown
                                    inputId="dropdown"
                                    [autoDisplayFirst]="false"
                                    [options]="parciales"
                                    formControlName="tipo_muestra"
                                    optionLabel="nombre"
                                    optionValue="nombre"
                                    (onChange)="cambioUnidad($event)"
                                ></p-dropdown>
                                <label for="dropdown">TIPO DE PESO</label>

                            </span>
                        </div>
                        <div class="field col-12 md:col-4">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="peso_neto_total"
                                    pInputText
                                    formControlName="peso_neto_total"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Peso Aproximado Total Parciales (Kg.)</label>
                                <small id="peso_neto_total" class="p-error "*ngIf="formulario_interno.esCampoInvalido('peso_neto_total')">
                                    {{formulario_interno.getErrorMessage('peso_neto_total')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-4">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="humedad"
                                    pInputText
                                    formControlName="humedad"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Humedad (%)</label>
                                <small id="humedad" class="p-error "*ngIf="formulario_interno.esCampoInvalido('humedad')">
                                    {{formulario_interno.getErrorMessage('humedad')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-4">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="merma"
                                    pInputText
                                    formControlName="merma"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Merma (0-1)</label>
                                <small id="merma" class="p-error "*ngIf="formulario_interno.esCampoInvalido('merma')">
                                    {{formulario_interno.getErrorMessage('merma')}}
                                </small>
                            </span>
                        </div>
                        <div *ngIf="false" class="field col-12 md:col-4">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="peso_neto_parcial"
                                    pInputText
                                    formControlName="peso_neto_parcial"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Peso Neto Parcial (Kg.)</label>
                                <small id="peso_neto_parcial" class="p-error "*ngIf="formulario_interno.esCampoInvalido('peso_neto_parcial')">
                                    {{formulario_interno.getErrorMessage('peso_neto_parcial')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-3 ">
                            <app-mineralesSelect [tipo]="'NO COMPUESTO'" (mineral_id)="cambioMineralId($event)" (sigla)="cambioSigla($event)" (nombre)="cambioNombreMineral($event)"></app-mineralesSelect>
                        </div>
                        <div class="field col-12 md:col-3">
                            <span class="p-float-label">
                                <input
                                    type="number"
                                    id="nro_viajes"
                                    pInputText
                                    (input)="cambioLey($event)"
                                    class="ng-dirty"
                                />
                                <label for="Razón Social">Ley</label>
                                <small id="nro_viajes" class="p-error "*ngIf="formulario_interno.esCampoInvalido('nro_viajes')">
                                    {{formulario_interno.getErrorMessage('nro_viajes')}}
                                </small>
                            </span>
                        </div>
                        <div class="field col-12 md:col-3 ">
                            <span class="p-float-label">
                                <p-dropdown
                                    inputId="dropdown"
                                    [autoDisplayFirst]="false"
                                    [options]="unidades"
                                    optionLabel="nombre"
                                    optionValue="nombre"
                                    (onChange)="cambioUnidad($event)"
                                ></p-dropdown>
                                <label for="dropdown">Unidad</label>

                            </span>
                        </div>
                        <div class="field col-12 md:col-2">
                            <button pButton pRipple (click)="agregarLey()" type="button" icon="pi pi-plus" label="Agregar" class="p-button-outlined p-button-success"></button>
                        </div>

                        <div class="field col-12">
                            <p-table #dt [value]="lista_leyes_mineral"
                            responsiveLayout="scroll" [rows]="10"
                            [paginator]="false"  [showCurrentPageReport]="false"
                            selectionMode="multiple"
                            [rowHover]="true"
                            dataKey="id">

                                <ng-template pTemplate="header">
                                    <tr>

                                        <th pSortableColumn="code">Descripción <p-sortIcon field="code"></p-sortIcon></th>
                                        <th pSortableColumn="code">Sigla <p-sortIcon field="code"></p-sortIcon></th>
                                        <th pSortableColumn="name">Ley <p-sortIcon field="name"></p-sortIcon></th>
                                        <th pSortableColumn="price">Unidad <p-sortIcon field="price"></p-sortIcon></th>
                                        <th pSortableColumn="price">Acción <p-sortIcon field="price"></p-sortIcon></th>

                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-product>
                                    <tr>

                                        <td style="width:30%; min-width:20rem;"><span class="p-column-title">Descripción</span>
                                            {{product.descripcion}}
                                        </td>
                                        <td style="width:14%; min-width:8rem;">
                                            <span class="p-column-title">Sigla</span>
                                            {{product.sigla_mineral}}
                                        </td>
                                        <td style="width:14%; min-width:10rem;">
                                            <span class="p-column-title">Ley</span>
                                            {{product.ley}}
                                        </td>
                                        <td style="width:14%; min-width:8rem;">
                                            <span class="p-column-title">Unidad</span>
                                            {{product.unidad}}
                                        </td>
                                        <td>
                                            <div class="flex">
                                                <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="eliminar(product)"></button>
                                            </div>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                        <div class="field col-12 md:col-12 ">
                            <h5>2.2 Origen del Mineral </h5>
                        </div>

                          <div class="field col-12 md:col-3 ">
                              <app-departamentoSelect [departamento_id]="departamento_id" (cambioDepartamento)="cambioDepartamento($event)" (nombre_departamento)="cambioNombreDepartemento($event)"></app-departamentoSelect>
                          </div>
                          <div class="field col-12 md:col-3 ">
                              <app-municipioSelect [departamento_id]="departamento_id" [municipio_id1]="municipio_id" (municipio_id)="cambioMunicipio($event)" (nombre_municipio)="cambioNombreMunicipio($event)"></app-municipioSelect>
                          </div>

                          <div class="field col-12 md:col-2">
                              <button pButton pRipple (click)="agregarMunicipio()" type="button" icon="pi pi-plus" label="Agregar" class="p-button-outlined p-button-success"></button>
                          </div>

                          <div class="field col-12">
                              <p-table #dt [value]="lista_municipios_origen"
                              responsiveLayout="scroll" [rows]="10"
                              [paginator]="false"  [showCurrentPageReport]="false"
                              selectionMode="multiple"
                              [rowHover]="true"
                              dataKey="id">

                                  <ng-template pTemplate="header">
                                      <tr>

                                          <th pSortableColumn="code">Departamento <p-sortIcon field="code"></p-sortIcon></th>
                                          <th pSortableColumn="code">Municipio <p-sortIcon field="code"></p-sortIcon></th>
                                          <th pSortableColumn="name">ID Municipio <p-sortIcon field="name"></p-sortIcon></th>
                                          <th pSortableColumn="price">Acción <p-sortIcon field="price"></p-sortIcon></th>

                                      </tr>
                                  </ng-template>
                                  <ng-template pTemplate="body" let-product>
                                      <tr>

                                          <td style="width:30%; min-width:20rem;"><span class="p-column-title">Departamento</span>
                                              {{product.departamento}}
                                          </td>
                                          <td style="width:14%; min-width:8rem;">
                                              <span class="p-column-title">Municipio</span>
                                              {{product.municipio}}
                                          </td>
                                          <td style="width:14%; min-width:10rem;">
                                              <span class="p-column-title">Ley</span>
                                              {{product.municipio_id}}
                                          </td>
                                          <td>
                                              <div class="flex">
                                                  <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="eliminarMunicipio(product)"></button>
                                              </div>
                                          </td>
                                      </tr>
                                  </ng-template>
                              </p-table>
                          </div>
                      </div>
                  </div>
                    <div *ngIf="activeStep === 2">
                        <div class="grid p-fluid mt-2">
                            <div class="field col-12 md:col-12 ">
                                <h5>2.1 Datos de Exportacion </h5>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="m03_id"
                                        pInputText
                                        formControlName="m03_id"
                                        class="ng-dirty"
                                    />
                                    <label for="m03_id">ID M-03</label>
                                    <small id="m03_id" class="p-error "*ngIf="formulario_interno.esCampoInvalido('m03_id')">
                                        {{formulario_interno.getErrorMessage('m03_id')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="laboratorio"
                                        pInputText
                                        formControlName="laboratorio"
                                        class="ng-dirty"
                                    />
                                    <label for="laboratorio">Laboratorio</label>
                                    <small id="laboratorio" class="p-error "*ngIf="formulario_interno.esCampoInvalido('laboratorio')">
                                        {{formulario_interno.getErrorMessage('laboratorio')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="codigo_analisis"
                                        pInputText
                                        formControlName="codigo_analisis"
                                        class="ng-dirty"
                                    />
                                    <label for="codigo_analisis">Codigo de Analisis</label>
                                    <small id="codigo_analisis" class="p-error "*ngIf="formulario_interno.esCampoInvalido('codigo_analisis')">
                                        {{formulario_interno.getErrorMessage('codigo_analisis')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="nro_factura_exportacion"
                                        pInputText
                                        formControlName="nro_factura_exportacion"
                                        class="ng-dirty"
                                    />
                                    <label for="nro_factura_exportacion">N° Factura Comercial de Exportación</label>
                                    <small id="nro_factura_exportacion" class="p-error "*ngIf="formulario_interno.esCampoInvalido('nro_factura_exportacion')">
                                        {{formulario_interno.getErrorMessage('nro_factura_exportacion')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-12 ">
                                <h5>2.1 Datos de Destino </h5>
                            </div>
                            <div  class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="comprador"
                                        pInputText
                                        formControlName="comprador"
                                        class="ng-dirty"
                                    />
                                    <label for="comprador">Comprador</label>
                                    <small id="comprador" class="p-error "*ngIf="formulario_interno.esCampoInvalido('comprador')">
                                        {{formulario_interno.getErrorMessage('comprador')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <app-paisSelect [pais_id]="pais_id" (cambioPais)="cambioPais($event)" ></app-paisSelect>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <app-aduanaSelect [aduana_id]="aduana_id" (cambioAduana)="cambioAduana($event)" ></app-aduanaSelect>
                            </div>
                        </div>
                    </div>
                  <div class="col-12">
                    <div class="flex justify-content-center gap-3 mt-4">
                        <!-- Botón Anterior (solo visible si no es el primer paso) -->
                        <div *ngIf="activeStep > 0">
                            <button pButton pRipple type="button" label="Anterior"
                                class="p-button-rounded p-button-secondary"
                                (click)="prevStep()" icon="pi pi-arrow-left">
                            </button>
                        </div>

                        <!-- Botón Siguiente o Guardar -->
                        <div *ngIf="activeStep !== steps.length - 1">
                            <button pButton pRipple type="button" label="Siguiente"
                                class="p-button-rounded p-button-success"
                                (click)="nextStep()" icon="pi pi-arrow-right" iconPos="right">
                            </button>
                        </div>
                        <div *ngIf="activeStep === steps.length - 1">
                            <button pButton pRipple type="button" label="Guardar"
                                class="p-button-rounded p-button-info"
                                (click)="onSubmit()" icon="pi pi-save">
                            </button>
                        </div>

                        <!-- Botón Cancelar -->
                        <div>
                            <button pButton pRipple type="button" label="Cancelar"
                                class="p-button-rounded p-button-danger"
                                [routerLink]="['/public/toma-de-muestra']" icon="pi pi-trash">
                            </button>
                        </div>
                    </div>
                  </div>


              </div>
          </div>

</form>

<!-- MODAL PARA GENERAR PARCIAL HIJO -->
<p-dialog [(visible)]="dialogoAgregarParcial" [style]="{width: '700px'}" header="Generar Parcial Hijo" [modal]="true" class="p-fluid">
    <form [formGroup]="formularioParcialHijo.formulario">
        <div class="grid p-fluid">
            <div class="col-12">
                <p-message severity="info" text="Los datos del padre se heredan automáticamente. Solo ingrese los datos específicos de este parcial."></p-message>
            </div>
            <div class="col-12">
                <p-message severity="info" text="Disponible: {{pesoRestante}} Kg, Camiones: {{camionesRestantes}}"></p-message>
            </div>

            <div class="field col-12 md:col-6">
                <span class="p-float-label">
                    <input type="number" id="nro_camiones_hijo" pInputText formControlName="nro_camiones" class="ng-dirty" required/>
                    <label for="nro_camiones_hijo">Nro. de Camiones/Vagones *</label>
                </span>
            </div>

            <div class="field col-12 md:col-6">
                <span class="p-float-label">
                    <input type="number" id="peso_neto_total_hijo" pInputText formControlName="peso_neto_total" class="ng-dirty" required/>
                    <label for="peso_neto_total_hijo">Peso Neto (Kg.) *</label>
                </span>
            </div>

            <div class="field col-12">
                <span class="p-float-label">
                    <p-calendar inputId="fecha_hora_tdm_hijo" dateFormat="dd-mm-yy" formControlName="fecha_hora_tdm"
                        [showTime]="true" hourFormat="24" [required]="true"></p-calendar>
                    <label for="fecha_hora_tdm_hijo">Fecha y Hora de Toma de Muestra *</label>
                </span>
            </div>

            <div class="field col-12">
                <span class="p-float-label">
                    <p-dropdown
                        [options]="listaUsuarios"
                        formControlName="responsable_tdm_id"
                        optionLabel="nombreCompleto"
                        optionValue="id"
                        [autoDisplayFirst]="false"
                        placeholder="Seleccione Responsable"></p-dropdown>
                    <label for="responsable_tdm_id">Responsable de Toma de Muestra *</label>
                </span>
            </div>

            <div class="field col-12">
                <span class="p-float-label">
                    <textarea id="observaciones_hijo" pInputTextarea formControlName="observaciones" rows="3"></textarea>
                    <label for="observaciones_hijo">Observaciones (Opcional)</label>
                </span>
            </div>

            <div class="col-12">
                <p-divider></p-divider>
                <p><strong>Datos heredados del padre:</strong></p>
                <ul>
                    <li>Lote: {{muestraPadre?.lote}}</li>
                    <li>Lugar: {{muestraPadre?.lugar_verificacion}}</li>
                    <li>Minerales: Heredados automáticamente</li>
                    <li>Municipios origen: Heredados automáticamente</li>
                </ul>
            </div>
        </div>
    </form>

    <ng-template pTemplate="footer">
        <button pButton pRipple type="button" label="Cancelar" icon="pi pi-times"
            class="p-button-text" (click)="dialogoAgregarParcial = false"></button>
        <button pButton pRipple type="button" label="Guardar Parcial" icon="pi pi-check"
            class="p-button-success" (click)="crearParcialHijo()"></button>
    </ng-template>
</p-dialog>

<p-confirmDialog header="Confirmacion" key="confirm1" icon="pi pi-exclamation-triangle" message="Esta seguro de anular el formulario?"
                [style]="{width: '350px'}" acceptButtonStyleClass="p-button-text" rejectButtonStyleClass="p-button-text"
                acceptLabel="Si"
                rejectLabel="No">
</p-confirmDialog>

<p-dialog [(visible)]="verDialog" [style]="{width: '700px'}"
        [modal]="true" header="Estado de Toma de Muestra"
        class="p-fluid">
    <app-ver-toma-de-muestra
        [id]="toma_de_muestra_id"
        (estadoDialogo)="cerrar($event)">
    </app-ver-toma-de-muestra>
</p-dialog>





