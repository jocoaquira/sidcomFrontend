
<form [formGroup]="formulario_externo.formulario" (ngSubmit)="onSubmit()">
    <div class="card-titulo">
        <h4 class="text-center" style="color: white;">CREACION DE NUEVO FORMULARIO 101 EXTERNO</h4>
    </div>
        <div class="grid p-fluid">
            <div class="card card-w-title flex flex-wrap col-12">
                <div class="col-12">
                    <p-steps [model]="steps" [(activeIndex)]="activeStep"
                    styleClass="mt-1" [readonly]="true"
                    ></p-steps>
                </div>
                <div class="col-12" >
                    <div *ngIf="activeStep === 0"
                    >
                        <div class="grid p-fluid">
                            <h5 class="field-subtitle mb-0 mt-1 col-12 py-1">Información de Medio de Transporte</h5>

                            <div class="field col-12 md:col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    inputId="dropdown"
                                    [autoDisplayFirst]="false"
                                    [options]="tipo_transporte"
                                    formControlName="tipo_transporte"
                                    optionLabel="nombre"
                                    optionValue="nombre"
                                ></p-dropdown>
                                <label for="dropdown">Tipo de Transporte</label>
                                <small id="tipo_transporte" class="p-error " *ngIf="formulario_externo.esCampoInvalido('tipo_transporte')">
                                    {{formulario_externo.getErrorMessage('tipo_transporte')}}
                                </small>
                            </span>
                            </div>

                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte==='VIA FERREA'" class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="empresa_ferrea"
                                        pInputText
                                        formControlName="empresa_ferrea"
                                        class="ng-dirty"
                                    />
                                    <label for="empresa_ferrea">Empresa Transoprtadora</label>
                                    <small id="empresa_ferrea" class="p-error "*ngIf="formulario_externo.esCampoInvalido('empresa_ferrea')">
                                        {{formulario_externo.getErrorMessage('empresa_ferrea')}}
                                    </small>
                                </span>
                            </div>
                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte==='VIA FERREA'" class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="nro_vagon"
                                        pInputText
                                        formControlName="nro_vagon"
                                        class="ng-dirty"
                                    />
                                    <label for="nro_vagon">N° de vagon(es)</label>
                                    <small id="nro_vagon" class="p-error "*ngIf="formulario_externo.esCampoInvalido('nro_vagon')">
                                        {{formulario_externo.getErrorMessage('nro_vagon')}}
                                    </small>
                                </span>
                            </div>

                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte==='VIA FERREA'" class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="date"
                                        id="fecha_ferrea"
                                        pInputText
                                        formControlName="fecha_ferrea"
                                        class="ng-dirty"
                                    />
                                    <label for="fecha_ferrea">Fecha de Salida</label>
                                    <small id="fecha_ferrea" class="p-error "*ngIf="formulario_externo.esCampoInvalido('fecha_ferrea')">
                                        {{formulario_externo.getErrorMessage('fecha_ferrea')}}
                                    </small>
                                </span>
                            </div>
                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte==='VIA FERREA'" class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="time"
                                        id="hr_ferrea"
                                        pInputText
                                        formControlName="hr_ferrea"
                                        class="ng-dirty"
                                    />
                                    <label for="hr_ferrea">Hora de Salida</label>
                                    <small id="hr_ferrea" class="p-error "*ngIf="formulario_externo.esCampoInvalido('hr_ferrea')">
                                        {{formulario_externo.getErrorMessage('hr_ferrea')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3 " *ngIf="formulario_externo.formulario.value.tipo_transporte!=='VIA FERREA'">
                                <app-vehiculoSelect [operador_id]="operador_id" [placa]="placa" (vehiculo)="cambioVehiculo($event)" ></app-vehiculoSelect>
                                <small id="placa" class="p-error "*ngIf="formulario_externo.esCampoInvalido('placa')">
                                        {{formulario_externo.getErrorMessage('placa')}}
                                </small>
                            </div>
                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte!=='VIA FERREA' && false" class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="placa"
                                        pInputText
                                        formControlName="placa"
                                        class="ng-dirty"
                                    />
                                    <label for="placa">Placa</label>
                                    <small id="placa" class="p-error "*ngIf="formulario_externo.esCampoInvalido('placa')">
                                        {{formulario_externo.getErrorMessage('placa')}}
                                    </small>
                                </span>
                            </div>
                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte!=='VIA FERREA' && false" class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="nom_conductor"
                                        pInputText
                                        formControlName="nom_conductor"
                                        class="ng-dirty"
                                    />
                                    <label for="nom_conductor">Nombre del Conductor</label>
                                    <small id="nom_conductor" class="p-error "*ngIf="formulario_externo.esCampoInvalido('nom_conductor')">
                                        {{formulario_externo.getErrorMessage('nom_conductor')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3 " *ngIf="formulario_externo.formulario.value.tipo_transporte!=='VIA FERREA'">
                                <app-choferSelect [operador_id]="operador_id" [nro_licencia]="nro_licencia"  (chofer)="cambioChofer($event)" ></app-choferSelect>
                                <small id="nom_conductor" class="p-error "*ngIf="formulario_externo.esCampoInvalido('nom_conductor')">
                                    {{formulario_externo.getErrorMessage('nom_conductor')}}
                                </small>
                            </div>
                            <div *ngIf="formulario_externo.formulario.value.tipo_transporte!=='VIA FERREA'" class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="licencia"
                                        pInputText
                                        formControlName="licencia"
                                        class="ng-dirty"
                                    />
                                    <label for="licencia">Licencia de Conducir</label>
                                    <small id="licencia" class="p-error "*ngIf="formulario_externo.esCampoInvalido('licencia')">
                                        {{formulario_externo.getErrorMessage('licencia')}}
                                    </small>
                                </span>
                            </div>


                            <h5 class="field-subtitle mb-0 mt-1 col-12 py-1">Datos de Exportación</h5>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="m03_id"
                                        pInputText
                                        formControlName="m03_id"
                                        class="ng-dirty"
                                    />
                                    <label for="ID M-03">ID M-03</label>
                                    <small id="m03_id" class="p-error "*ngIf="formulario_externo.esCampoInvalido('m03_id')">
                                        {{formulario_externo.getErrorMessage('m03_id')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="nro_factura_exportacion"
                                        pInputText
                                        formControlName="nro_factura_exportacion"
                                        class="ng-dirty"
                                    />
                                    <label for="Factura">N° Factura Comercial de Exportación</label>
                                    <small id="nro_factura_exportacion" class="p-error "*ngIf="formulario_externo.esCampoInvalido('nro_factura_exportacion')">
                                        {{formulario_externo.getErrorMessage('nro_factura_exportacion')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="laboratorio"
                                        pInputText
                                        formControlName="laboratorio"
                                        class="ng-dirty"
                                    />
                                    <label for="Laboratorio">Laboratorio</label>
                                    <small id="laboratorio" class="p-error "*ngIf="formulario_externo.esCampoInvalido('laboratorio')">
                                        {{formulario_externo.getErrorMessage('laboratorio')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="codigo_analisis"
                                        pInputText
                                        formControlName="codigo_analisis"
                                        class="ng-dirty"
                                    />
                                    <label for="Código de Analisis">Código de Analisis</label>
                                    <small id="codigo_analisis" class="p-error "*ngIf="formulario_externo.esCampoInvalido('codigo_analisis')">
                                        {{formulario_externo.getErrorMessage('codigo_analisis')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4" *ngIf="canCrearTomaDeMuestra.canActivate()">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="nro_formulario_tm"
                                        pInputText
                                        formControlName="nro_formulario_tm"
                                        class="ng-dirty"
                                        (input)="cambioNroFormulario($event)"
                                    />
                                    <label for="Acta de Verificación">Acta de Verificacion Toma de Muestra</label>
                                    <small id="nro_formulario_tm" class="p-error" *ngIf="formulario_externo.esCampoInvalido('nro_formulario_tm')">
                                        {{formulario_externo.getErrorMessage('nro_formulario_tm')}}
                                    </small>
                                    <small id="nro_formulario_tm" class="p-error " *ngIf="!acta_TDM">
                                        Se requiere un formulario de Toma de Muestra Aprobado
                                    </small>
                                </span>
                            </div>


                        </div>
                    </div>
                    <div *ngIf="activeStep === 1"
                    >
                        <div class="grid p-fluid mt-2">
                            <div class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="lote"
                                        pInputText
                                        formControlName="lote"
                                        class="ng-dirty"
                                    />
                                    <label for="Razón Social">Lote</label>
                                    <small id="lote" class="p-error "*ngIf="formulario_externo.esCampoInvalido('lote')">
                                        {{formulario_externo.getErrorMessage('lote')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-4">
                                <span class="p-float-label">
                                    <p-dropdown
                                        inputId="dropdown"
                                        [autoDisplayFirst]="false"
                                        [options]="presentaciones"
                                        formControlName="presentacion_id"
                                        optionLabel="nombre"
                                        optionValue="id"
                                        (onChange)="cambioPresentacion($event)"
                                    ></p-dropdown>
                                    <label for="dropdown">Presentacion</label>
                                    <small id="presentacion_id" class="p-error " *ngIf="formulario_externo.esCampoInvalido('presentacion_id')">
                                        {{formulario_externo.getErrorMessage('presentacion_id')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="cantidad"
                                        pInputText
                                        formControlName="cantidad"
                                        class="ng-dirty"
                                        [disabled]="presentacion.cantidad"
                                    />
                                    <label for="Razón Social">Cantidad</label>
                                    <small id="cantidad" class="p-error "*ngIf="formulario_externo.esCampoInvalido('cantidad')">
                                        {{formulario_externo.getErrorMessage('cantidad')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="peso_bruto_humedo"
                                        pInputText
                                        formControlName="peso_bruto_humedo"
                                        class="ng-dirty"
                                    />
                                    <label for="Razón Social">Peso bruto humedo (Kg.)</label>
                                    <small id="peso_bruto_humedo" class="p-error "*ngIf="formulario_externo.esCampoInvalido('peso_bruto_humedo')">
                                        {{formulario_externo.getErrorMessage('peso_bruto_humedo')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="tara"
                                        pInputText
                                        formControlName="tara"
                                        class="ng-dirty"
                                    />
                                    <label for="Razón Social">Tara (Kg.)</label>
                                    <small id="tara" class="p-error "*ngIf="formulario_externo.esCampoInvalido('tara')">
                                        {{formulario_externo.getErrorMessage('tara')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="humedad"
                                        pInputText
                                        formControlName="humedad"
                                        class="ng-dirty"
                                    />
                                    <label for="Razón Social">Humedad (%)</label>
                                    <small id="humedad" class="p-error "*ngIf="formulario_externo.esCampoInvalido('humedad')">
                                        {{formulario_externo.getErrorMessage('humedad')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-2">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="merma"
                                        pInputText
                                        formControlName="merma"
                                        class="ng-dirty"
                                    />
                                    <label for="Razón Social">Merma (%)</label>
                                    <small id="merma" class="p-error "*ngIf="formulario_externo.esCampoInvalido('merma')">
                                        {{formulario_externo.getErrorMessage('merma')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="peso_neto"
                                        pInputText
                                        formControlName="peso_neto"
                                        class="ng-dirty"
                                        readonly
                                    />
                                    <label for="Razón Social">Peso Neto Seco (Kg.)</label>
                                    <small id="peso_neto" class="p-error "*ngIf="formulario_externo.esCampoInvalido('peso_neto')">
                                        {{formulario_externo.getErrorMessage('peso_neto')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <app-mineralesSelect [tipo]="'NO COMPUESTO'" (mineral_id)="cambioMineralId($event)" (sigla)="cambioSigla($event)" (nombre)="cambioNombreMineral($event)"></app-mineralesSelect>
                            </div>
                            <div class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="number"
                                        id="nro_viajes"
                                        pInputText
                                        (input)="cambioLey($event)"
                                        class="ng-dirty"
                                    />
                                    <label for="Razón Social">Ley</label>
                                    <small id="nro_viajes" class="p-error "*ngIf="formulario_externo.esCampoInvalido('nro_viajes')">
                                        {{formulario_externo.getErrorMessage('nro_viajes')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <span class="p-float-label">
                                    <p-dropdown
                                        inputId="dropdown"
                                        [autoDisplayFirst]="false"
                                        [options]="unidades"
                                        optionLabel="nombre"
                                        optionValue="nombre"
                                        (onChange)="cambioUnidad($event)"
                                    ></p-dropdown>
                                    <label for="dropdown">Unidad</label>

                                </span>
                            </div>
                            <div class="field col-12 md:col-2">
                                <button pButton pRipple (click)="agregarLey()" type="button" icon="pi pi-plus" label="Agregar" class="p-button-outlined p-button-success"></button>
                            </div>

                            <div class="field col-12">
                                <p-table #dt [value]="lista_leyes_mineral"
                                responsiveLayout="scroll" [rows]="10"
                                [paginator]="false"  [showCurrentPageReport]="false"
                                selectionMode="multiple"
                                [rowHover]="true"
                                dataKey="id">

                                    <ng-template pTemplate="header">
                                        <tr>

                                            <th pSortableColumn="code">Descripción <p-sortIcon field="code"></p-sortIcon></th>
                                            <th pSortableColumn="code">Sigla <p-sortIcon field="code"></p-sortIcon></th>
                                            <th pSortableColumn="name">Ley <p-sortIcon field="name"></p-sortIcon></th>
                                            <th pSortableColumn="price">Unidad <p-sortIcon field="price"></p-sortIcon></th>
                                            <th pSortableColumn="price">Acción <p-sortIcon field="price"></p-sortIcon></th>

                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-product>
                                        <tr>

                                            <td style="width:30%; min-width:20rem;"><span class="p-column-title">Descripción</span>
                                                {{product.descripcion}}
                                            </td>
                                            <td style="width:14%; min-width:8rem;">
                                                <span class="p-column-title">Sigla</span>
                                                {{product.sigla_mineral}}
                                            </td>
                                            <td style="width:14%; min-width:10rem;">
                                                <span class="p-column-title">Ley</span>
                                                {{product.ley}}
                                            </td>
                                            <td style="width:14%; min-width:8rem;">
                                                <span class="p-column-title">Unidad</span>
                                                {{product.unidad}}
                                            </td>
                                            <td>
                                                <div class="flex">
                                                    <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="eliminar(product)"></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                            </div>


                            <div class="field col-12 md:col-3 ">
                                <app-departamentoSelect [departamento_id]="departamento_id" (cambioDepartamento)="cambioDepartamento($event)" (nombre_departamento)="cambioNombreDepartemento($event)"></app-departamentoSelect>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <app-municipioSelect [departamento_id]="departamento_id" [municipio_id1]="municipio_id" (municipio_id)="cambioMunicipio($event)" (nombre_municipio)="cambioNombreMunicipio($event)"></app-municipioSelect>
                            </div>

                            <div class="field col-12 md:col-2">
                                <button pButton pRipple (click)="agregarMunicipio()" type="button" icon="pi pi-plus" label="Agregar" class="p-button-outlined p-button-success"></button>
                            </div>

                            <div class="field col-12">
                                <p-table #dt [value]="lista_municipios_origen"
                                responsiveLayout="scroll" [rows]="10"
                                [paginator]="false"  [showCurrentPageReport]="false"
                                selectionMode="multiple"
                                [rowHover]="true"
                                dataKey="id">

                                    <ng-template pTemplate="header">
                                        <tr>

                                            <th pSortableColumn="code">Departamento <p-sortIcon field="code"></p-sortIcon></th>
                                            <th pSortableColumn="code">Municipio <p-sortIcon field="code"></p-sortIcon></th>
                                            <th pSortableColumn="name">ID Municipio <p-sortIcon field="name"></p-sortIcon></th>
                                            <th pSortableColumn="price">Acción <p-sortIcon field="price"></p-sortIcon></th>

                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-product>
                                        <tr>

                                            <td style="width:30%; min-width:20rem;"><span class="p-column-title">Departamento</span>
                                                {{product.departamento}}
                                            </td>
                                            <td style="width:14%; min-width:8rem;">
                                                <span class="p-column-title">Municipio</span>
                                                {{product.municipio}}
                                            </td>
                                            <td style="width:14%; min-width:10rem;">
                                                <span class="p-column-title">Ley</span>
                                                {{product.municipio_id}}
                                            </td>
                                            <td>
                                                <div class="flex">
                                                    <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="eliminarMunicipio(product)"></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="activeStep === 2"
                    >
                        <div class="grid p-fluid mt-2">

                            <div  class="field col-12 md:col-3">
                                <span class="p-float-label">
                                    <input
                                        type="text"
                                        id="comprador"
                                        pInputText
                                        formControlName="comprador"
                                        class="ng-dirty"
                                    />
                                    <label for="comprador">Comprador</label>
                                    <small id="comprador" class="p-error "*ngIf="formulario_externo.esCampoInvalido('comprador')">
                                        {{formulario_externo.getErrorMessage('comprador')}}
                                    </small>
                                </span>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <app-paisSelect [pais_id]="pais_id" (cambioPais)="cambioPais($event)" ></app-paisSelect>
                            </div>
                            <div class="field col-12 md:col-3 ">
                                <app-aduanaSelect [aduana_id]="aduana_id" (cambioAduana)="cambioAduana($event)" ></app-aduanaSelect>
                            </div>
                                                    <div class="field col-12 md:col-12">
                            <span class="p-float-label">
                                <textarea
                                    id="observaciones"
                                    pInputTextarea
                                    formControlName="observaciones"
                                    class="ng-dirty"
                                    rows="4"
                                    cols="150"
                                ></textarea>
                                <label for="observaciones">Observaciones</label>
                                <small id="observaciones" class="p-error" *ngIf="formulario_externo.esCampoInvalido('observaciones')">
                                    {{ formulario_externo.getErrorMessage('observaciones') }}
                                </small>
                            </span>
                        </div>
                        <div class="card-declaracion text-center">
                            <h5 class="text-center"><strong>DECLARACIÓN JURADA DE TRANSPORTE DE MINERALES</strong></h5>
                            <p>El Formulario 101 es el único instrumento que habilita el transporte de minerales y/o
                                metales al interior o exterior del país, que permite la identificación del Municipio,
                                Departamento Productor y otros datos técnicos,<strong> tiene carácter de Declaración Jurada
                                de uso obligatorio conforme al Art. 31 del D.D. de Oruro N° 157 </strong>para los actores productivos mineros, operadores mineros, comercializadoras y personas naturales que se encuentran en posesión o realicen el transporte de minerales y/o metales en sujeción al D.S. N° 2288, Art 7


                            </p>

                                <div class="field-checkbox">
                                  <input
                                    type="checkbox"
                                    id="sf"
                                    [ngModelOptions]="{standalone: true}"
                                    [(ngModel)]="declaracionJurada"
                                    (change)="declaracionJuradaSwitch($event)"
                                    class="custom-checkbox"
                                  />
                                  <label for="sf">Acepto la DDJJ</label>
                                </div>
                        </div>
                        </div>
                    </div>

                    <div class="centrar-botones">
                        <div class="col-33" *ngIf="activeStep > 0">
                            <button pButton pRipple type="button" label="Anterior"
                            class="p-button-rounded p-button-secondary boton-ajustado"
                            (click)="prevStep()"
                            icon="pi pi-arrow-left"></button>
                        </div>
                        <div class="col-33" *ngIf="activeStep!== steps.length - 1">
                            <button pButton pRipple type="button" label="Siguiente"
                            class="p-button-rounded p-button-success boton-icono-derecha boton-ajustado"
                            (click)="nextStep()"
                            icon="pi pi-arrow-right">
                            </button>
                        </div>
                        <div class="col-33" *ngIf="activeStep=== steps.length - 1">
                            <button pButton pRipple type="button" label="Guardar"
                            class="p-button-rounded p-button-info  boton-ajustado"
                            (click)="guardar()"
                            icon="pi pi-save"
                            [disabled]="!declaracionJurada">
                            </button>
                        </div>
                        <div class="col-33">
                            <button pButton pRipple type="button" label="Cancelar"
                            class="p-button-rounded p-button-danger boton-ajustado"
                            [routerLink]="['/public/formulario-101/formulario-externo']"
                            icon="pi pi-trash"></button>
                        </div>

                    </div>
                </div>

            </div>

        </div>
</form>
